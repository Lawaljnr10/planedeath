<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Persistent Mousekoin Miner</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #miner, #adminPanel { display: none; margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
    button { padding: 10px 15px; margin: 5px 0; }
    #walletInfo { margin-top: 10px; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: center; }
  </style>
</head>
<body>
  <h1>Mousekoin Miner</h1>
  <button id="connectWalletBtn">Connect Wallet</button>
  <div id="walletInfo"></div>

  <div id="miner">
    <h2>Miner Interface</h2>
    <p>Mined MSK: <span id="minedAmount">0</span> MSK</p>
    <p>Time Remaining: <span id="timeRemaining">10:00</span></p>
    <button id="startMiningBtn">Start Mining</button>
    <button id="withdrawBtn" disabled>Withdraw Mined MSK</button>

    <!-- User Withdrawal History -->
    <div id="userWithdrawalHistory" style="display:none;">
      <h3>Your Withdrawal History</h3>
      <table id="userWithdrawalTable">
        <thead>
          <tr>
            <th>Amount (MSK)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- Withdrawal records for the user will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>

  <div id="adminPanel">
    <h2>Admin Panel</h2>
    <h3>All Withdrawal Requests</h3>
    <table id="adminWithdrawalTable">
      <thead>
        <tr>
          <th>User Wallet</th>
          <th>Amount (MSK)</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- All withdrawal records will be loaded here -->
      </tbody>
    </table>
  </div>

  <script>
    // Set admin wallet address (lowercase for comparisons)
    const adminAddress = "0xde45f6a59a96daa0ae7f26bad254aa88241b8d04";
    let userAccount = "";
    let miningInterval;
    let minedAmount = 0;
    const ratePerSecond = 0.000000000138;
    const miningDuration = 10 * 60; // 10 minutes in seconds
    let sessionFinished = false;

    // Data persistence using localStorage
    // withdrawals: an object with wallet addresses as keys and arrays of withdrawal records as values.
    // minedProgress: an object with wallet addresses as keys to store current session minedAmount.
    let withdrawals = JSON.parse(localStorage.getItem('withdrawals')) || {};
    let minedProgress = JSON.parse(localStorage.getItem('minedProgress')) || {};

    // Save both withdrawals and minedProgress to localStorage
    function saveData() {
      localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
      localStorage.setItem('minedProgress', JSON.stringify(minedProgress));
    }

    // Load the current user's mining progress from localStorage
    function loadUserData() {
      minedAmount = minedProgress[userAccount] || 0;
      document.getElementById('minedAmount').innerText = minedAmount.toFixed(12);
    }

    // Connect wallet button event using the injected Ethereum provider
    document.getElementById('connectWalletBtn').addEventListener('click', async function() {
      if (window.ethereum) {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          userAccount = accounts[0].toLowerCase();
          document.getElementById('walletInfo').innerText = "Connected: " + userAccount;
          
          document.getElementById('miner').style.display = "block";
          document.getElementById('userWithdrawalHistory').style.display = "block";
          
          // If connected account is admin, show the admin panel.
          if (userAccount === adminAddress) {
            document.getElementById('adminPanel').style.display = "block";
          }
          
          // Load saved progress and update tables
          loadUserData();
          updateUserWithdrawalTable();
          updateAdminWithdrawalTable();
        } catch (error) {
          console.error(error);
          alert("Wallet connection failed!");
        }
      } else {
        alert("Please install a compatible wallet.");
      }
    });

    // Function to start a mining session.
    function startMiningSession() {
      let secondsPassed = 0;
      document.getElementById('startMiningBtn').disabled = true;
      document.getElementById('startMiningBtn').innerText = "Mining in progress...";
      
      miningInterval = setInterval(() => {
        secondsPassed++;
        minedAmount += ratePerSecond;
        document.getElementById('minedAmount').innerText = minedAmount.toFixed(12);
        minedProgress[userAccount] = minedAmount; // Update progress persistently
        
        let remaining = miningDuration - secondsPassed;
        let minutes = Math.floor(remaining / 60);
        let seconds = remaining % 60;
        document.getElementById('timeRemaining').innerText =
          `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // End session when timer expires.
        if (secondsPassed >= miningDuration) {
          clearInterval(miningInterval);
          document.getElementById('withdrawBtn').disabled = false;
          document.getElementById('startMiningBtn').disabled = false;
          document.getElementById('startMiningBtn').innerText = "Start New Session";
          sessionFinished = true;
          saveData();
        }
      }, 1000);
    }

    // Start mining button event.
    // If a session was already finished (but not withdrawn), ask if the user wants to record it.
    document.getElementById('startMiningBtn').addEventListener('click', function() {
      if (sessionFinished && minedAmount > 0) {
        const confirmSave = confirm("Your finished session mined " + minedAmount.toFixed(12) + " MSK. " +
                                      "This will be saved as a pending withdrawal before starting a new session. Proceed?");
        if (confirmSave) {
          if (!withdrawals[userAccount]) withdrawals[userAccount] = [];
          withdrawals[userAccount].push({ amount: minedAmount, status: "pending" });
          updateUserWithdrawalTable();
          updateAdminWithdrawalTable();
          minedAmount = 0;
          document.getElementById('minedAmount').innerText = "0";
          sessionFinished = false;
          saveData();
        } else {
          return;
        }
      }
      startMiningSession();
    });

    // Withdraw button event.
    // Submits the current mined amount as a pending withdrawal.
    document.getElementById('withdrawBtn').addEventListener('click', function() {
      if (!withdrawals[userAccount]) withdrawals[userAccount] = [];
      if (minedAmount > 0) {
        withdrawals[userAccount].push({ amount: minedAmount, status: 'pending' });
        alert("Your withdrawal request for " + minedAmount.toFixed(12) + " MSK is pending admin approval.");
      } else {
        alert("No mined amount available to withdraw.");
      }
      // Reset the session.
      minedAmount = 0;
      document.getElementById('minedAmount').innerText = "0";
      document.getElementById('withdrawBtn').disabled = true;
      document.getElementById('startMiningBtn').disabled = false;
      document.getElementById('startMiningBtn').innerText = "Start Mining";
      document.getElementById('timeRemaining').innerText = "10:00";
      sessionFinished = false;
      
      // Save updates.
      minedProgress[userAccount] = minedAmount;
      saveData();
      updateUserWithdrawalTable();
      updateAdminWithdrawalTable();
    });

    // Update the connected user’s withdrawal table.
    function updateUserWithdrawalTable() {
      const tableBody = document.querySelector("#userWithdrawalTable tbody");
      tableBody.innerHTML = "";
      const userRecords = withdrawals[userAccount] || [];
      userRecords.forEach(record => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${record.amount.toFixed(12)}</td><td>${record.status}</td>`;
        tableBody.appendChild(row);
      });
    }

    // Update the admin panel’s withdrawal table to list all requests.
    function updateAdminWithdrawalTable() {
      const tableBody = document.querySelector("#adminWithdrawalTable tbody");
      tableBody.innerHTML = "";
      for (const [wallet, records] of Object.entries(withdrawals)) {
        records.forEach((record, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${wallet}</td>
            <td>${record.amount.toFixed(12)}</td>
            <td>${record.status}</td>
            <td>
              <button onclick="copyWallet('${wallet}')">Copy</button>
              ${record.status === 'pending' ? `<button onclick="approveWithdrawal('${wallet}', ${index})">Approve</button>` : ''}
            </td>
          `;
          tableBody.appendChild(row);
        });
      }
    }

    // Copy wallet address to clipboard.
    function copyWallet(wallet) {
      navigator.clipboard.writeText(wallet)
        .then(() => alert("Wallet address copied: " + wallet))
        .catch(() => alert("Failed to copy wallet address."));
    }

    // Approve a withdrawal request (admin only).
    function approveWithdrawal(wallet, index) {
      withdrawals[wallet][index].status = 'approved';
      saveData();
      updateUserWithdrawalTable();
      updateAdminWithdrawalTable();
    }
  </script>
</body>
</html>
