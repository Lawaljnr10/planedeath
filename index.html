<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mousekoin Miner</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #miner, #adminPanel { display: none; margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
    button { padding: 10px 15px; margin: 5px 0; }
    #walletInfo { margin-top: 10px; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: center; }
  </style>
</head>
<body>
  <h1>Mousekoin Miner</h1>
  <button id="connectWalletBtn">Connect Wallet</button>
  <div id="walletInfo"></div>

  <div id="miner">
    <h2>Miner Interface</h2>
    <p>Mined MSK: <span id="minedAmount">0</span> MSK</p>
    <p>Time Remaining: <span id="timeRemaining">10:00</span></p>
    <button id="startMiningBtn">Start Mining</button>
    <button id="withdrawBtn" disabled>Withdraw Mined MSK</button>

    <!-- User Withdrawal History -->
    <div id="userWithdrawalHistory" style="display:none;">
      <h3>Your Withdrawal History</h3>
      <table id="userWithdrawalTable">
        <thead>
          <tr>
            <th>Amount (MSK)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- User withdrawal records will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <div id="adminPanel">
    <h2>Admin Panel</h2>
    <p>Welcome, Admin! You can perform administrative tasks here.</p>
    <!-- Withdrawal History Table for Admin -->
    <h3>All Withdrawal Requests</h3>
    <table id="adminWithdrawalTable">
      <thead>
        <tr>
          <th>User Wallet</th>
          <th>Amount (MSK)</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Admin withdrawal records will be inserted here -->
      </tbody>
    </table>
  </div>

  <script>
    // Set the admin wallet address (in lowercase for comparison)
    const adminAddress = "0xde45f6a59a96daa0ae7f26bad254aa88241b8d04";
    let userAccount = "";
    let miningInterval;
    let minedAmount = 0;
    const ratePerSecond = 0.000000000138; // MSK mined per second
    const miningDuration = 10 * 60; // 10 minutes in seconds
    let sessionFinished = false; // indicates if a session finished without withdrawal

    // Array to store withdrawal records
    // Each record: { wallet, amount, status } where status is "pending" or "approved"
    let withdrawals = [];

    // Connect wallet button event
    document.getElementById('connectWalletBtn').addEventListener('click', async function() {
      if (window.ethereum) {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          userAccount = accounts[0];
          document.getElementById('walletInfo').innerText = "Connected account: " + userAccount;
          // Show miner interface once connected
          document.getElementById('miner').style.display = "block";
          // Show the user's withdrawal history section
          document.getElementById('userWithdrawalHistory').style.display = "block";
          // If the connected account is the admin, show the admin panel
          if (userAccount.toLowerCase() === adminAddress) {
            document.getElementById('adminPanel').style.display = "block";
            updateAdminWithdrawalTable();
          }
          updateUserWithdrawalTable();
        } catch (error) {
          console.error(error);
          alert("Wallet connection failed!");
        }
      } else {
        alert("Please install Trust Wallet or a compatible wallet provider.");
      }
    });

    // Function to start a mining session
    function startMiningSession() {
      // Reset display values for new session
      minedAmount = 0;
      document.getElementById('minedAmount').innerText = "0";
      document.getElementById('timeRemaining').innerText = "10:00";
      document.getElementById('withdrawBtn').disabled = true;
      sessionFinished = false;
      
      let secondsPassed = 0;
      document.getElementById('startMiningBtn').disabled = true;
      document.getElementById('startMiningBtn').innerText = "Mining in progress...";

      miningInterval = setInterval(() => {
        secondsPassed++;
        minedAmount += ratePerSecond;
        document.getElementById('minedAmount').innerText = minedAmount.toFixed(12);

        // Calculate remaining time
        let remaining = miningDuration - secondsPassed;
        let minutes = Math.floor(remaining / 60);
        let seconds = remaining % 60;
        document.getElementById('timeRemaining').innerText =
          (minutes < 10 ? "0" + minutes : minutes) + ":" + (seconds < 10 ? "0" + seconds : seconds);

        // When the 10-minute period is over, stop mining,
        // enable withdraw button and also allow starting a new session.
        if (secondsPassed >= miningDuration) {
          clearInterval(miningInterval);
          document.getElementById('withdrawBtn').disabled = false;
          document.getElementById('startMiningBtn').disabled = false;
          document.getElementById('startMiningBtn').innerText = "Start New Session";
          sessionFinished = true;
        }
      }, 1000);
    }

    // Start mining button event
    document.getElementById('startMiningBtn').addEventListener('click', function() {
      // If a session has finished and minedAmount > 0, ask if user wants to record it as a pending withdrawal.
      if (sessionFinished && minedAmount > 0) {
        const confirmSave = confirm("Your previous session mined " + minedAmount.toFixed(12) + " MSK. " +
                                      "If you start a new session now, the mined amount from the finished session will be saved as a pending withdrawal. Proceed?");
        if (confirmSave) {
          const withdrawalRecord = {
            wallet: userAccount,
            amount: minedAmount,
            status: "pending"
          };
          withdrawals.push(withdrawalRecord);
          updateUserWithdrawalTable();
          updateAdminWithdrawalTable();
          // Reset minedAmount before starting new session.
          minedAmount = 0;
          document.getElementById('minedAmount').innerText = "0";
          sessionFinished = false;
        } else {
          // If user cancels, do not start a new session.
          return;
        }
      }
      startMiningSession();
    });

    // Withdraw button event
    document.getElementById('withdrawBtn').addEventListener('click', function() {
      // Create a withdrawal record for the finished session with pending status
      if (minedAmount > 0) {
        const withdrawalRecord = {
          wallet: userAccount,
          amount: minedAmount,
          status: "pending"
        };
        withdrawals.push(withdrawalRecord);
        updateUserWithdrawalTable();
        updateAdminWithdrawalTable();
        alert("Your withdrawal request for " + minedAmount.toFixed(12) + " MSK is now pending admin approval.");
      } else {
        alert("No mined amount available to withdraw.");
      }
      // Reset for potential new mining session
      minedAmount = 0;
      document.getElementById('minedAmount').innerText = "0";
      document.getElementById('withdrawBtn').disabled = true;
      document.getElementById('startMiningBtn').disabled = false;
      document.getElementById('startMiningBtn').innerText = "Start Mining";
      document.getElementById('timeRemaining').innerText = "10:00";
      sessionFinished = false;
    });

    // Update the user's withdrawal table (only shows records for the connected user)
    function updateUserWithdrawalTable() {
      const tableBody = document.querySelector("#userWithdrawalTable tbody");
      tableBody.innerHTML = "";
      const userRecords = withdrawals.filter(record => record.wallet.toLowerCase() === userAccount.toLowerCase());
      userRecords.forEach(record => {
        const row = document.createElement("tr");
        const amountCell = document.createElement("td");
        amountCell.innerText = record.amount.toFixed(12);
        const statusCell = document.createElement("td");
        statusCell.innerText = record.status;
        row.appendChild(amountCell);
        row.appendChild(statusCell);
        tableBody.appendChild(row);
      });
    }

    // Update the admin withdrawal table (shows all withdrawal requests)
    function updateAdminWithdrawalTable() {
      const tableBody = document.querySelector("#adminWithdrawalTable tbody");
      tableBody.innerHTML = "";
      withdrawals.forEach((record, index) => {
        const row = document.createElement("tr");

        // Wallet address cell
        const walletCell = document.createElement("td");
        walletCell.innerText = record.wallet;
        row.appendChild(walletCell);

        // Amount cell
        const amountCell = document.createElement("td");
        amountCell.innerText = record.amount.toFixed(12);
        row.appendChild(amountCell);

        // Status cell
        const statusCell = document.createElement("td");
        statusCell.innerText = record.status;
        row.appendChild(statusCell);

        // Actions cell: Copy button and Approve button if pending
        const actionsCell = document.createElement("td");

        const copyBtn = document.createElement("button");
        copyBtn.innerText = "Copy";
        copyBtn.addEventListener("click", () => {
          navigator.clipboard.writeText(record.wallet)
            .then(() => { alert("Copied wallet address: " + record.wallet); })
            .catch(() => { alert("Failed to copy wallet address."); });
        });
        actionsCell.appendChild(copyBtn);

        if (record.status === "pending") {
          const approveBtn = document.createElement("button");
          approveBtn.innerText = "Approve";
          approveBtn.style.marginLeft = "10px";
          approveBtn.addEventListener("click", () => {
            withdrawals[index].status = "approved";
            updateAdminWithdrawalTable();
            updateUserWithdrawalTable();
          });
          actionsCell.appendChild(approveBtn);
        }
        row.appendChild(actionsCell);
        tableBody.appendChild(row);
      });
    }
  </script>
</body>
</html>
